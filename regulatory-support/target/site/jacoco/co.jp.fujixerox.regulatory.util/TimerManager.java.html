<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimerManager.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">regulatory-support</a> &gt; <a href="index.html" class="el_package">co.jp.fujixerox.regulatory.util</a> &gt; <span class="el_source">TimerManager.java</span></div><h1>TimerManager.java</h1><pre class="source lang-java linenums">package co.jp.fujixerox.regulatory.util;

import java.io.InputStream;
import java.util.Calendar;
import java.util.Date;
import java.util.Properties;
import java.util.Timer;

import javax.servlet.ServletContextEvent;
import javax.servlet.ServletContextListener;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

public class TimerManager implements ServletContextListener {
<span class="nc" id="L16">	private static final Logger logger = LogManager.getLogger(Pdf2HtmlUtil.class.getName());</span>
	// 時間間隔
 	private static final long PERIOD_DAY = 24 * 60 * 60 * 1000;
<span class="nc" id="L19"> 	private Properties props = null;</span>
 	
 	// タイマー
 	private Timer timer;
 	
<span class="nc" id="L24">    public TimerManager() {</span>
    	try{
<span class="nc" id="L26">			props = new Properties();</span>
<span class="nc" id="L27">			InputStream in = this.getClass().getClassLoader().getResourceAsStream(&quot;system.properties&quot;);</span>
<span class="nc" id="L28">			props.load(in);</span>
<span class="nc" id="L29">    	} catch (Exception e) {</span>
<span class="nc" id="L30">            throw new ExceptionInInitializerError(e);</span>
<span class="nc" id="L31">        }</span>
<span class="nc" id="L32">    }</span>

    /**
     * Html変換任務を実行します
     */
 	public void contextInitialized(ServletContextEvent event) {
<span class="nc" id="L38"> 		logger.info(&quot;定時任務を起動します&quot;);</span>
<span class="nc" id="L39"> 		String hour = props.getProperty(&quot;batchstart_hour&quot;);</span>
<span class="nc" id="L40"> 		String minute = props.getProperty(&quot;batchstart_minute&quot;);</span>
<span class="nc" id="L41"> 		String second = props.getProperty(&quot;batchstart_second&quot;);</span>

<span class="nc" id="L43">		Calendar calendar = Calendar.getInstance();</span>
	
		/*** 2:00実行 ***/
<span class="nc" id="L46">		calendar.set(Calendar.HOUR_OF_DAY, Integer.parseInt(hour));</span>
	
<span class="nc" id="L48">		calendar.set(Calendar.MINUTE, Integer.parseInt(minute));</span>
	
<span class="nc" id="L50">		calendar.set(Calendar.SECOND, Integer.parseInt(second));</span>
	
		// 初めて任務の時間
<span class="nc" id="L53">		Date date=calendar.getTime();</span>
	
		// 実行して時間はシステム時間より小きく
<span class="nc bnc" id="L56" title="All 2 branches missed.">		if (date.before(new Date())) {</span>
<span class="nc" id="L57">		    date = this.addDay(date, 1);</span>
		}
	
<span class="nc" id="L60">		timer = new Timer(&quot;convert2Html&quot;, true);</span>
	
<span class="nc" id="L62">		Convert2HtmlTimerTask task = new Convert2HtmlTimerTask();</span>
	
		// 実行任務
<span class="nc" id="L65">		timer.schedule(task,date,PERIOD_DAY);</span>
<span class="nc" id="L66">	}</span>
	
	/**  
	 * Web応用が終わる時任務を停止します
	 */
	public void contextDestroyed(ServletContextEvent event) {
<span class="nc" id="L72">		timer.cancel();   </span>
<span class="nc" id="L73">		logger.info(&quot;定時任務を停止します&quot;);</span>
<span class="nc" id="L74">	}   </span>

	/**
	 * 日数を追加します
	 * @param date 初めて任務の時間
	 * @param num  日数
	 * @return 追加後の時間
	 */
	public Date addDay(Date date, int num) {
<span class="nc" id="L83">		Calendar startDT = Calendar.getInstance();</span>
<span class="nc" id="L84">		startDT.setTime(date);</span>
<span class="nc" id="L85">		startDT.add(Calendar.DAY_OF_MONTH, num);</span>
<span class="nc" id="L86">		return startDT.getTime();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://jacoco.org">JaCoCo</a> 0.5.3.201107060350</span></div></body></html>